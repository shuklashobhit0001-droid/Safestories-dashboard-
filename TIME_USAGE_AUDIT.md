# Time Usage Audit - Complete Application Analysis

## Executive Summary
This document lists **ALL** places where time/session timings are displayed in the UI across Admin and Therapist dashboards, and how they are stored in the database.

---

## Database Storage Format

### Primary Time Fields in Database

#### 1. **bookings** table
- **`booking_start_at`** (TIMESTAMP)
  - Format: PostgreSQL TIMESTAMP (e.g., `2025-01-21 17:00:00`)
  - Timezone: Stored in UTC, but connection is set to 'Asia/Kolkata' in `lib/db.ts`
  - Used for: Filtering, sorting, date range queries

- **`booking_invitee_time`** (TEXT)
  - Format: Human-readable string (e.g., `"Wednesday, Jan 21, 2026 at 5:00 PM - 5:50 PM (GMT+05:30)"`)
  - Timezone: Contains timezone offset in the string
  - Used for: Display in UI after conversion to IST

- **`invitee_created_at`** (TIMESTAMP)
  - Format: PostgreSQL TIMESTAMP
  - Used for: Client creation tracking

#### 2. **audit_logs** table
- **`timestamp`** (TEXT)
  - Format: Formatted IST string (e.g., `"Wed, Jan 21, 2025 at 05:00 PM IST"`)
  - Generated by: `getCurrentISTTimestamp()` function in server
  - Used for: Audit trail display

#### 3. **notifications** table
- **`created_at`** (TIMESTAMP)
  - Format: PostgreSQL TIMESTAMP with default CURRENT_TIMESTAMP
  - Used for: Notification time display

#### 4. **client_session_notes** table
- **`created_at`** (TIMESTAMP)
- **`updated_at`** (TIMESTAMP)
  - Format: PostgreSQL TIMESTAMP
  - Used for: Session notes timeline

#### 5. **client_additional_notes** table
- **`created_at`** (TIMESTAMP)
- **`updated_at`** (TIMESTAMP)
  - Format: PostgreSQL TIMESTAMP
  - Used for: Additional notes timeline and edit validation (5-minute window)

---

## UI Display Locations

### ADMIN DASHBOARD

#### 1. **Dashboard View** (`components/Dashboard.tsx`)

**Upcoming Bookings Table:**
- **Column:** "Session Timings"
- **Source:** `booking.booking_start_at` (converted from `booking_invitee_time`)
- **Format:** IST format via `convertToIST()` function
- **Example:** "Wednesday, Jan 21, 2026 at 5:00 PM - 5:50 PM IST"
- **Line:** 1015

**Latest Notifications:**
- **Display:** Notification date
- **Source:** `notification.created_at`
- **Format:** `toLocaleDateString()`
- **Line:** 1055

**Live Sessions Count:**
- **Display:** "Live Sessions: X"
- **Source:** Real-time calculation from `booking_invitee_time`
- **Logic:** Checks if current time is between session start and end
- **Line:** 893

#### 2. **All Clients View** (`components/AllClients.tsx`)

**Client Details Modal - Appointments:**
- **Column:** "Session Timings"
- **Source:** `appointment.booking_invitee_time` (converted to IST)
- **Format:** IST format via `convertToIST()`
- **Line:** Not directly visible in provided code, but used in client details

#### 3. **Appointments View** (`components/Appointments.tsx`)

**Appointments Table:**
- **Column:** "Session Timings"
- **Source:** `apt.booking_start_at` (converted from `booking_invitee_time`)
- **Format:** IST format via `convertToIST()`
- **Example:** "Wednesday, Jan 21, 2026 at 5:00 PM - 5:50 PM IST"
- **Line:** 368

**Copy to Clipboard:**
- **Content:** Session timings included in copied text
- **Source:** `apt.booking_start_at`
- **Line:** 82

**Meeting End Check:**
- **Logic:** Parses `booking_start_at` to check if meeting ended
- **Used for:** Disabling "Send Reminder" button
- **Line:** 93-104

#### 4. **Refunds & Cancellations View** (`components/RefundsCancellations.tsx`)

**Refunds Table:**
- **Column:** "Session Date & Time"
- **Source:** `refund.session_timings`
- **Format:** IST format (formatted in backend)
- **Example:** "Wednesday, Jan 21, 2026 at 5:00 PM - 5:50 PM IST"
- **Line:** 103

#### 5. **Audit Logs View** (`components/AuditLogs.tsx`)

**Audit Logs Table:**
- **Column:** "Timestamp"
- **Source:** `log.timestamp`
- **Format:** IST string or formatted from PostgreSQL timestamp
- **Example:** "Wed, Jan 21, 2025 at 05:00 PM IST"
- **Line:** 115

**Format Function:**
- **Function:** `formatTimestamp()`
- **Handles:** Both IST strings and PostgreSQL timestamps
- **Line:** 52-68

#### 6. **Notifications View** (`components/Notifications.tsx`)

**Notifications List:**
- **Display:** Relative time (e.g., "5m ago", "2h ago", "3d ago")
- **Source:** `notification.created_at`
- **Format Function:** `formatTime()`
- **Line:** 88-103

---

### THERAPIST DASHBOARD

#### 1. **Dashboard View** (`components/TherapistDashboard.tsx`)

**Upcoming Bookings Table:**
- **Column:** "Session Timings"
- **Source:** `booking.session_timings` (converted to IST)
- **Format:** IST format via `convertToIST()`
- **Line:** 1398

**Pending Session Notes Table:**
- **Column:** "Session Timings"
- **Source:** `appointment.session_timings`
- **Format:** IST format
- **Line:** 1476

**Latest Notifications:**
- **Display:** Notification date
- **Source:** `notification.created_at`
- **Format:** `toLocaleDateString()`
- **Line:** 1540

#### 2. **My Appointments View** (`components/TherapistDashboard.tsx`)

**Appointments Table:**
- **Column:** "Session Timings"
- **Source:** `appointment.session_timings`
- **Format:** IST format via `convertToIST()`
- **Line:** 1003

**Meeting Status Checks:**
- **Function:** `isMeetingStarted()` - Line 577
- **Function:** `isMeetingEnded()` - Line 587
- **Logic:** Parses session_timings to check current status
- **Used for:** Enabling/disabling action buttons

**SOS Ticket Validation:**
- **Logic:** Checks if session started and within 24 hours of end
- **Source:** `booking.session_timings`
- **Line:** 711-738

#### 3. **My Clients View** (`components/TherapistDashboard.tsx`)

**Client Detail - Appointments Table:**
- **Column:** "Date & Time"
- **Source:** `apt.session_timings`
- **Format:** IST format
- **Line:** 1267

**Client Stats Date Filter:**
- **Display:** Selected month/date range
- **Used for:** Filtering client appointments by date
- **Line:** 1177-1203

#### 4. **Session Notes View** (`components/TherapistDashboard.tsx`)

**Session Notes Display:**
- **Field:** "Session Timings"
- **Source:** `sessionNotesData.session_timing`
- **Format:** IST format
- **Line:** 1625

**Timeline View:**
- **Display:** Action timestamp
- **Source:** `item.timestamp` (from session notes or additional notes)
- **Format:** "Jan 21, 2025 at 05:00 PM"
- **Line:** 1663-1669

**Additional Notes:**
- **Display:** Note creation date
- **Source:** `note.created_at`
- **Format:** `toLocaleDateString()`
- **Line:** 1717

**Edit Time Window:**
- **Logic:** Checks if note was created within 5 minutes
- **Source:** `note.created_at`
- **Calculation:** `Math.abs((now.getTime() - createdAt.getTime()) / (1000 * 60))`
- **Line:** 1703-1706

---

## Time Conversion Functions

### 1. **`convertToIST()`** - `lib/timezone.ts`
- **Purpose:** Converts booking time string to IST format
- **Input:** `"Wednesday, Jan 21, 2026 at 5:00 PM - 5:50 PM (GMT+05:30)"`
- **Output:** `"Wednesday, Jan 21, 2026 at 5:00 PM - 5:50 PM IST"`
- **Used in:** All booking/appointment displays

### 2. **`getCurrentISTTimestamp()`** - `server/index.ts`
- **Purpose:** Generates current IST timestamp string
- **Output:** `"Wed, Jan 21, 2025 at 05:00 PM IST"`
- **Used in:** Audit logs creation

### 3. **`formatTimestamp()`** - `components/AuditLogs.tsx`
- **Purpose:** Formats audit log timestamps
- **Handles:** Both IST strings and PostgreSQL timestamps

### 4. **`formatTime()`** - `components/Notifications.tsx`
- **Purpose:** Converts timestamp to relative time
- **Output:** "5m ago", "2h ago", "3d ago", or date

---

## API Endpoints Using Time

### 1. **`/api/live-sessions-count`**
- **Time Field:** `booking_invitee_time`
- **Logic:** Parses time string to check if session is currently live
- **Line:** server/index.ts:66-91

### 2. **`/api/dashboard/stats`**
- **Time Field:** `booking_start_at`
- **Usage:** Date range filtering with `BETWEEN` clause
- **Line:** server/index.ts:94-220

### 3. **`/api/dashboard/bookings`**
- **Time Fields:** `booking_start_at`, `booking_invitee_time`
- **Usage:** Filtering and display
- **Conversion:** `convertToIST()` applied
- **Line:** server/index.ts:223-257

### 4. **`/api/appointments`**
- **Time Fields:** `booking_start_at`, `booking_invitee_time`
- **Usage:** Display and status determination
- **Line:** server/index.ts:344-391

### 5. **`/api/therapist-stats`**
- **Time Field:** `booking_start_at`
- **Usage:** Date range filtering for stats
- **Line:** server/index.ts:577-686

### 6. **`/api/therapist-appointments`**
- **Time Fields:** `booking_start_at`, `booking_invitee_time`
- **Usage:** Display with IST conversion
- **Line:** server/index.ts:689-732

### 7. **`/api/client-appointments`**
- **Time Fields:** `booking_start_at`, `booking_invitee_time`
- **Usage:** Client-specific appointment display
- **Line:** server/index.ts:835-903

### 8. **`/api/refunds`**
- **Time Field:** `session_timings`
- **Usage:** Display with IST formatting
- **Line:** server/index.ts:1234-1289

### 9. **`/api/notifications`**
- **Time Field:** `created_at`
- **Usage:** Sorting and display
- **Line:** server/index.ts:1292-1307

### 10. **`/api/session-notes`**
- **Time Fields:** `created_at`, `updated_at`, `session_timing`
- **Usage:** Timeline and display
- **Line:** server/index.ts:1418-1441

### 11. **`/api/additional-notes`**
- **Time Fields:** `created_at`, `updated_at`
- **Usage:** Timeline and edit validation
- **Line:** server/index.ts:1378-1415

---

## Summary of Time Display Formats

### 1. **Full Session Timing (IST)**
- **Format:** "Wednesday, Jan 21, 2026 at 5:00 PM - 5:50 PM IST"
- **Used in:** All appointment/booking tables
- **Source:** `booking_invitee_time` → `convertToIST()`

### 2. **Audit Log Timestamp**
- **Format:** "Wed, Jan 21, 2025 at 05:00 PM IST"
- **Used in:** Audit logs table
- **Source:** `getCurrentISTTimestamp()`

### 3. **Notification Relative Time**
- **Format:** "5m ago", "2h ago", "3d ago"
- **Used in:** Notifications list
- **Source:** `created_at` → `formatTime()`

### 4. **Session Notes Timeline**
- **Format:** "Jan 21, 2025 at 05:00 PM"
- **Used in:** Session notes timeline
- **Source:** `created_at` → `toLocaleString()`

### 5. **Simple Date**
- **Format:** "1/21/2025"
- **Used in:** Additional notes, notification dates
- **Source:** `created_at` → `toLocaleDateString()`

---

## Database Timezone Configuration

**Connection Setting:**
```typescript
// lib/db.ts
pool.on('connect', (client) => {
  client.query("SET timezone = 'Asia/Kolkata'");
});
```

**Impact:**
- All PostgreSQL TIMESTAMP fields are interpreted in IST (Asia/Kolkata timezone)
- `CURRENT_TIMESTAMP` returns IST time
- Date comparisons work in IST

---

## Potential Issues & Recommendations

### Current Issues:
1. **Mixed Time Storage:** Some fields store formatted strings, others store timestamps
2. **Timezone Inconsistency:** `booking_invitee_time` contains timezone offset, but conversion may not handle all cases
3. **Edit Window Calculation:** Uses `Math.abs()` which may cause issues with timezone differences

### Recommendations:
1. **Standardize Storage:** Store all times as PostgreSQL TIMESTAMP in UTC
2. **Convert on Display:** Always convert to IST in the frontend
3. **Use ISO 8601:** For API responses, use ISO 8601 format
4. **Timezone Library:** Consider using `date-fns-tz` or `luxon` for reliable timezone handling

---

## Next Steps

**Should I proceed with any changes?**

Please review this audit and let me know if you'd like me to:
1. Fix timezone inconsistencies
2. Standardize time storage format
3. Update time display formatting
4. Add timezone conversion utilities
5. Fix any specific time-related bugs

**What would you like me to do next?**

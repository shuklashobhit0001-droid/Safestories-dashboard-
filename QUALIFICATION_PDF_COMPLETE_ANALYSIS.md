# Qualification PDF Storage - Complete Analysis

## üìã Summary

Qualification PDFs are handled in **4 different forms** across the application, but only **2 of them** actually upload and store PDFs.

---

## ‚úÖ Forms That UPLOAD Qualification PDFs

### 1. CompleteProfileModal.tsx
**Used by**: New therapists completing profile after OTP login

**Upload**: ‚úÖ YES
- Uploads to MinIO before form submission
- Shows progress message: "Uploading qualification PDF..."
- Folder: `qualification-pdfs/`
- Max size: 5MB

**Database Storage**: `therapist_details.qualification_pdf_url`

**Flow**:
```
New Therapist ‚Üí OTP Login ‚Üí CompleteProfileModal ‚Üí Upload to MinIO ‚Üí Store URL in therapist_details
```

**Code Location**: Lines 226-256
```typescript
if (qualificationFile) {
  setError('Uploading qualification PDF...');
  const formData = new FormData();
  formData.append('file', qualificationFile);
  formData.append('folder', 'qualification-pdfs');
  
  const uploadResponse = await fetch('/api/upload-file', {
    method: 'POST',
    body: formData
  });
  
  const uploadData = await uploadResponse.json();
  if (uploadData.success) {
    qualificationPdfUrl = uploadData.url;
  }
}
```

---

### 2. EditProfile.tsx
**Used by**: Approved therapists editing their profile

**Upload**: ‚úÖ YES
- Uploads to MinIO when therapist updates their profile
- Shows current file name if already uploaded
- Folder: `qualification-pdfs/`
- Max size: 5MB

**Database Storage**: `therapists.qualification_pdf_url`

**Flow**:
```
Approved Therapist ‚Üí Edit Profile ‚Üí Upload to MinIO ‚Üí Update therapists.qualification_pdf_url
```

**Code Location**: Lines 247-275
```typescript
if (qualificationFile) {
  const formData = new FormData();
  formData.append('file', qualificationFile);
  formData.append('folder', 'qualification-pdfs');

  const uploadResponse = await fetch('/api/upload-file', {
    method: 'POST',
    body: formData
  });

  const uploadData = await uploadResponse.json();
  if (uploadData.success) {
    qualificationPdfUrl = uploadData.url;
  }
}
```

---

## ‚ùå Forms That DO NOT Upload Qualification PDFs

### 3. NewTherapist.tsx (Admin Form)
**Used by**: Admin adding new therapist request

**Upload**: ‚ùå NO
- Only captures basic info (name, email, phone, specializations)
- No file upload fields at all
- Sends OTP to therapist for profile completion

**Database Storage**: `new_therapist_requests` table (no PDF field)

**Why no upload?**
- This is just the initial request form
- Therapist will upload PDF later in CompleteProfileModal

---

### 4. AdminEditProfile.tsx
**Used by**: Admin editing their own profile

**Upload**: ‚ùå NO
- Only handles admin's profile picture
- No qualification PDF field (admins don't need qualifications)

**Database Storage**: `users.profile_picture_url` (admin profile)

**Why no upload?**
- This is for admin users, not therapists
- Admins don't have qualification PDFs

---

## üóÑÔ∏è Database Storage Locations

### Table: `therapist_details`
**Column**: `qualification_pdf_url` (TEXT)

**Stores**: URLs for pending review therapists
- Used by: CompleteProfileModal
- Status: `pending_review`
- Example: `https://s3.fluidjobs.ai:9002/safestories-panel/qualification-pdfs/abc123.pdf`

### Table: `therapists`
**Column**: `qualification_pdf_url` (TEXT)

**Stores**: URLs for approved therapists
- Used by: EditProfile
- Status: `approved`
- Example: `https://s3.fluidjobs.ai:9002/safestories-panel/qualification-pdfs/xyz789.pdf`

---

## üì¶ MinIO Storage

**Bucket**: `safestories-panel`

**Folder**: `qualification-pdfs/`

**URL Format**: 
```
https://s3.fluidjobs.ai:9002/safestories-panel/qualification-pdfs/{filename}
```

**File Naming**: Generated by MinIO (UUID-based)

**Max Size**: 5MB

**Allowed Format**: PDF only (`.pdf`)

---

## üîÑ Complete Data Flow

### New Therapist Onboarding:
```
1. Admin ‚Üí NewTherapist.tsx (no PDF upload)
   ‚Üì
2. Therapist receives OTP email
   ‚Üì
3. Therapist ‚Üí CompleteProfileModal.tsx (uploads PDF)
   ‚Üì
4. PDF uploaded to MinIO ‚Üí qualification-pdfs/
   ‚Üì
5. URL stored in therapist_details.qualification_pdf_url
   ‚Üì
6. Status: pending_review
   ‚Üì
7. Admin approves
   ‚Üì
8. Data copied to therapists.qualification_pdf_url
   ‚Üì
9. Status: approved
```

### Approved Therapist Editing Profile:
```
1. Therapist ‚Üí EditProfile.tsx
   ‚Üì
2. Uploads new PDF (optional)
   ‚Üì
3. PDF uploaded to MinIO ‚Üí qualification-pdfs/
   ‚Üì
4. URL updated in therapists.qualification_pdf_url
```

---

## üéØ Key Points

1. **Only 2 forms upload PDFs**: CompleteProfileModal and EditProfile
2. **NewTherapist form does NOT upload**: It's just the initial request
3. **AdminEditProfile does NOT upload**: It's for admin profiles, not therapists
4. **Two database tables**: `therapist_details` (pending) and `therapists` (approved)
5. **Same MinIO folder**: Both use `qualification-pdfs/`
6. **Same upload endpoint**: Both use `/api/upload-file`

---

## ‚úÖ Current Status

All qualification PDF upload functionality is:
- ‚úÖ Implemented in CompleteProfileModal
- ‚úÖ Implemented in EditProfile
- ‚úÖ Uploading to MinIO correctly
- ‚úÖ Storing URLs in database
- ‚úÖ Showing upload progress
- ‚úÖ Handling errors properly

---

## üìù Notes

- Profile pictures use the same upload system but different folder: `profile-pictures/`
- Both use the same `/api/upload-file` endpoint
- Upload happens BEFORE form submission to ensure URLs are available
- If upload fails, form submission is blocked with error message


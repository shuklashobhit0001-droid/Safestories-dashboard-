// ============================================
// DATABASE SCHEMA - SafeStories Therapy Platform
// ============================================

// User Management
Table users {
  id integer [pk, increment]
  username varchar(255) [not null]
  password varchar(255) [not null]
  name varchar(255) [not null]
  role varchar(50) [default: 'admin']
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  therapist_id varchar(50)
  full_name varchar(255)
}

// Therapists Master Data
Table therapists {
  id integer [pk, increment]
  therapist_id varchar(255) [not null, unique]
  name varchar(255) [not null]
  specialization text
  contact_info varchar(255)
  sessions_booked integer [default: 0]
  capacity integer [default: 0]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Main Bookings Data
Table bookings {
  invitee_id text
  invitee_name text
  invitee_phone text
  invitee_email text
  invitee_question text
  invitee_token text
  invitee_country text
  invitee_city text
  invitee_timezone text
  invitee_created_at timestamp
  invitee_cancelled_at timestamp
  invitee_cancelled_reason text
  invitee_status text
  invitee_payment_reference_id text
  invitee_payment_gateway text
  invitee_payment_name text
  invitee_payment_currency text
  invitee_payment_amount numeric
  booking_user_id text
  booking_updated_at timestamp
  booking_subject text
  booking_status text
  booking_resource_id text
  booking_resource_type text
  booking_resource_name text
  booking_checkin_url text
  booking_mode text
  booking_joining_link text
  booking_invitee_time text
  booking_host_user_id text
  booking_host_name text
  booking_host_phone text
  booking_host_email text
  booking_start_at timestamp
  booking_end_at timestamp
  booking_duration integer
  booking_cancelled_by text
  booking_cancel_reason text
  booking_id text
  booking_account_id text
  refund_amount numeric
  refund_status varchar(255)
  refund_failed_time timestamp
  rescheduled_at timestamp
  rescheduled_start_at timestamp
  rescheduled_end_at timestamp
  recheduled_from timestamp
  emergency_contact_name varchar(255)
  emergency_contact_relation varchar(100)
  emergency_contact_number varchar(20)
  therapist_id varchar(255)
  refund_id varchar(255)
}

// Booking Cancellations
Table booking_cancelled {
  id integer [pk, increment]
  booking_id text
  invitee_id text
  invitee_name text
  invitee_number text
  invitee_email text
  cancelled_at timestamp
  cancelled_by text
  cancel_reason text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Booking Requests
Table booking_requests {
  request_id integer [pk, increment]
  client_name varchar(255) [not null]
  client_whatsapp varchar(20) [not null]
  client_email varchar(255)
  therapy_type varchar(255) [not null]
  therapist_name varchar(255) [not null]
  booking_link text
  status varchar(50) [default: 'sent']
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  is_free_consultation boolean [default: false]
}

// Session Notes
Table client_session_notes {
  note_id integer [pk, increment]
  booking_id text
  client_name text
  session_timing text
  host_name text
  session_status text
  client_age integer
  gender text
  occupation text
  marital_status text
  concerns_discussed text
  somatic_cues array
  interventions_used text
  interventions_helpful text
  client_participation text
  goal_progress text
  client_values text
  self_harm_mention text
  self_harm_details text
  current_risk_level text
  protective_factors text
  health_history text
  past_diagnoses text
  next_session_plan text
  homework_suggested text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Additional Notes
Table client_additional_notes {
  note_id integer [pk, increment]
  booking_id integer [not null]
  therapist_id varchar(255)
  therapist_name varchar(255)
  note_text text [not null]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
}

// Document Forms
Table client_doc_form {
  link_id integer [pk, increment]
  booking_id varchar(50)
  paperform_link text
  status varchar(20)
}

// Client Transfer History
Table client_transfer_history {
  transfer_id integer [pk, increment]
  client_name varchar(255) [not null]
  client_email varchar(255)
  client_phone varchar(50)
  from_therapist_id varchar(50)
  from_therapist_name varchar(255)
  to_therapist_id varchar(50) [not null]
  to_therapist_name varchar(255) [not null]
  transferred_by_admin_id integer
  transferred_by_admin_name varchar(255)
  transfer_date timestamp [default: `CURRENT_TIMESTAMP`]
  reason text
  notes text
}

// Payments & Refunds
Table payments {
  payment_id integer [pk, increment]
  booking_id text
  invitee_name text
  invitee_email text
  payment_reference_id text
  amount numeric
  currency varchar(10)
  payment_date timestamp
  payment_gateway_name text
  refund_amount numeric
  refund_initiation_date timestamp
  refund_status varchar(50)
  refund_failed_date timestamp
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]
  refund_id varchar(255)
}

Table refund_cancellation_table {
  id integer [pk, increment]
  client_id varchar(255)
  client_name varchar(255)
  session_id varchar(255)
  session_name varchar(255)
  session_timings timestamp
  payment_id varchar(255)
  refund_status varchar(50)
  refund_id varchar(255)
}

// Therapist Dashboard Cache Tables
Table therapist_dashboard_stats {
  id integer [pk, increment]
  therapist_id varchar(50) [not null, unique]
  total_sessions integer [default: 0]
  confirmed_sessions integer [default: 0]
  cancelled_sessions integer [default: 0]
  no_shows integer [default: 0]
  upcoming_bookings integer [default: 0]
  last_updated timestamp [default: `now()`]
}

Table therapist_clients_summary {
  id integer [pk, increment]
  therapist_id varchar(50) [not null]
  client_name varchar(255)
  client_email varchar(255)
  client_phone varchar(50)
  total_sessions integer [default: 0]
  last_session_date timestamp
  created_at timestamp [default: `now()`]
}

Table therapist_appointments_cache {
  id integer [pk, increment]
  therapist_id varchar(50) [not null]
  session_timings varchar(500)
  session_name varchar(500)
  client_name varchar(255)
  contact_info varchar(100)
  mode varchar(100)
  booking_date timestamp
  booking_status varchar(50)
  created_at timestamp [default: `now()`]
}

Table therapist_resources {
  id integer [pk, increment]
  resource_id integer [not null]
  resource_name varchar(255) [not null]
  therapist_id varchar(255) [not null]
  therapist_name varchar(255)
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  therapy_name varchar(255)
}

// Admin Management Tables
Table all_clients_table {
  client_id varchar(255) [pk, not null]
  client_name varchar(255)
  phone_number varchar(50)
  email_id varchar(255)
  no_of_sessions integer [default: 0]
  therapist_id varchar(255)
  assigned_therapist varchar(255)
}

Table appointment_table {
  session_id varchar(255) [pk, not null]
  session_timings timestamp
  session_name varchar(255)
  session_mode varchar(50)
  client_id varchar(255)
  client_name varchar(255)
  contact_info text
  therapist_id varchar(255)
  therapist_name varchar(255)
}

// Audit & Notifications
Table audit_logs {
  log_id integer [pk, increment]
  therapist_id varchar(50)
  therapist_name varchar(255)
  action_type varchar(100) [not null]
  action_description text [not null]
  client_name varchar(255)
  ip_address varchar(50)
  is_visible boolean [default: true]
  timestamp varchar(255) [default: `get_ist_timestamp()`]
}

Table notifications {
  notification_id integer [pk, increment]
  user_id varchar(50)
  user_role varchar(20) [not null]
  notification_type varchar(100) [not null]
  title varchar(255) [not null]
  message text [not null]
  related_id varchar(50)
  is_read boolean [default: false]
  created_at timestamp [default: `CURRENT_TIMESTAMP AT TIME ZONE 'Asia/Kolkata'`]
}

// Marketing Integration
Table aisensy_campaign_api {
  campaign_name varchar(255)
  therapy varchar(255)
  therapist_name varchar(255)
}

// ============================================
// RELATIONSHIPS (Foreign Keys)
// ============================================

// Therapist Relationships
Ref: users.therapist_id > therapists.therapist_id
Ref: bookings.therapist_id > therapists.therapist_id
Ref: therapist_dashboard_stats.therapist_id > therapists.therapist_id
Ref: therapist_clients_summary.therapist_id > therapists.therapist_id
Ref: therapist_appointments_cache.therapist_id > therapists.therapist_id
Ref: all_clients_table.therapist_id > therapists.therapist_id
Ref: appointment_table.therapist_id > therapists.therapist_id
Ref: client_transfer_history.from_therapist_id > therapists.therapist_id
Ref: client_transfer_history.to_therapist_id > therapists.therapist_id
Ref: client_additional_notes.therapist_id > therapists.therapist_id
Ref: audit_logs.therapist_id > therapists.therapist_id

// Booking Relationships
Ref: client_additional_notes.booking_id > bookings.booking_id
Ref: payments.booking_id > bookings.booking_id
Ref: refund_cancellation_table.session_id > bookings.booking_id
Ref: booking_cancelled.booking_id > bookings.booking_id
Ref: client_doc_form.booking_id > bookings.booking_id

// User Relationships
Ref: notifications.user_id > users.id

// Client Relationships (existing in DB)
Ref: appointment_table.client_id > all_clients_table.client_id
Ref: refund_cancellation_table.client_id > all_clients_table.client_id

// Additional Relationships (existing in DB)
Ref: refund_cancellation_table.session_id > appointment_table.session_id

// ============================================
// RELATIONSHIP SUMMARY
// ============================================
// Total Foreign Keys: 22
// 
// Parent Tables:
//   - therapists (11 child tables)
//   - bookings (5 child tables)
//   - users (1 child table)
//   - all_clients_table (2 child tables)
//   - appointment_table (1 child table)
//
// Tables WITHOUT Foreign Keys (Standalone):
//   - aisensy_campaign_api (uses names, not IDs)
//   - booking_requests (pre-booking tracking, not linked)
//   - therapist_resources (has orphaned data: therapist_id 58605)
//   - client_session_notes (has orphaned data: booking_id 56430)
//   - therapists (parent table)
// ============================================
